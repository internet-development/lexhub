services:
  lexhub:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lexhub
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      nexus:
        condition: service_started
    ports:
      - "10000:10000"
    environment:
      - NODE_ENV=production
      - NEXUS_URL=http://nexus:8080
      - DATABASE_URL=postgresql://lexhub:lexhub_password@postgres:5432/lexhub
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=lexhub
      - POSTGRES_PASSWORD=lexhub_password
      - POSTGRES_DB=lexhub

  nexus:
    build:
      context: .
      dockerfile: nexus.Dockerfile
    container_name: nexus
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - nexus_data:/app/data
    environment:
      # Relay configuration
      - NEXUS_RELAY_URL=https://relay1.us-east.bsky.network

      # Performance tuning
      - NEXUS_FIREHOSE_PARALLELISM=10
      - NEXUS_RESYNC_PARALLELISM=5
      - NEXUS_OUTBOX_PARALLELISM=5

      # Cursor and timeout settings
      - NEXUS_CURSOR_SAVE_INTERVAL=5s
      # - NEXUS_REPO_FETCH_TIMEOUT=180s

      # Network and filtering options
      - NEXUS_FULL_NETWORK_MODE=false
      - NEXUS_SIGNAL_COLLECTION=com.atproto.lexicon.schema
      - NEXUS_COLLECTION_FILTERS=com.atproto.lexicon.schema

      # Delivery options
      - NEXUS_DISABLE_ACKS=false
      - NEXUS_WEBHOOK_URL=http://lexhub:10000/api/ingest
      # - NEXUS_OUTBOX_ONLY=false

      # Logging
      - NEXUS_LOG_LEVEL=info

  postgres:
    image: postgres:17-alpine
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=lexhub
      - POSTGRES_PASSWORD=lexhub_password
      - POSTGRES_DB=lexhub
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
      - "-c"
      - "pg_stat_statements.track=all"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "maintenance_work_mem=128MB"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lexhub -d lexhub"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  nexus_data:
    driver: local
  postgres_data:
    driver: local
